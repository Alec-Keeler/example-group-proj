# Sequelize

Sequelize is an SQL ORM for Node.js. We'll be using Sequelize in our Node.js
applications to connect and manipulate PostgresQL databases.

## Sequelize Project Set Up

1. Create a `package.json` in the root of your project
   - `npm init -y`

2. `npm install` the following dependencies
   - `sequelize@5` - Sequelize version 5
   - `sequelize-cli@5` - Sequelize command-line tools version 5
   - `pg` - Node.js PostgresQL

3. Initialize Sequelize in your project
   - `npx sequelize init`
   - OR `npx sequelize-cli init`
   - create the following folders:
     - `config` - Database configuration
     - `migrations` - Sequelize Migration files for manipulating the database
       schema
     - `models` - Sequelize Model files for interacting with the database
     - `seeders` - Sequelize Seeder files for inserting data

4. Create a database user with `CREATEDB` access in `psql`'s command line
   - example:
     `psql -c "CREATE USER example_app WITH PASSWORD 'password' CREATEDB"`

5. Edit the `config/config.json` file for `development` (you can delete the
   `test` and `production` unless told otherwise for now)
   - Credentials of the database user that was just created
   - Database name
   - Database dialect to `postgres`
   - Delete `operatorAliases`
   - Add `"seederStorage": "sequelize"`
   - Optional: Add `"logger": true` if you want to see SQL queries run by
     Sequelize in the console

6. Create the database
   - `npx sequelize db:init`

If you want to drop the database, you can run `npx sequelize db:drop`

Refer to [Sequelize Migration docs] if you have any questions about how to
configure your Sequelize project

## Migrations

Create/edit/delete SQL tables and columns using **migrations**. A single
Sequelize migration file is a script that will be run on the database defined
in the `config/config.json` file.

Usually, you reserve one database schema change per one migration file.

In a single migration file, there is a `up` and a `down` migration. The `up`
migration will run when you want to make the change. The `down` migration will
run when you want to reverse the change.

**To generate a new migration file that will create a table** called `Cats` with
a `name` column and an `age` column, run the following command:
`npx sequelize model:generate --name Cat --attributes name:string,age:integer`

> Note: The `name` CLI option must be singular (and capitalized by convention).
> Attributes are column names and types that are separated by commas.
> This command also generates a migration file in the `migrations file` and a
> model file in the `models` folder.

Edit the migration file that was generated by the command to change the
constraints on the database columns or add/edit/delete columns from the desired
table.

Then, to run the `up` migration from the file, run the following command:
`npx sequelize db:migrate`. This will run any migration files in the
`migrations` folder that have not run or been migrated yet.

To undo all migrations, run `npx sequelize db:migrate:undo:all`. This will run
the `down` migration in all the files in the `migrations` folder.

> You can also undo to a certain migration by passing a `to` option to the CLI
> command.
> Example: `npx sequelize-cli db:migrate:undo:all --to <migration file name>`

## Models

The model file should have already been generated if you ran the
`model:generate` command when creating a migration file.

In the model file, you can add model-level constraints and validations that will
be checked and run before a request to insert/update/delete entries from the
table that the model is modeling. These are less secure than the database-level
constraints defined in the migration file.

Edits to the model file do not need to be migrated.

A model should represent how to interact with manipulating entries in the table
that it models. It should also define what the associations between other models
should be.

## Seeders

Files in the `seeders` folder define seed data for your database tables.

To generate a seeder file for the `Cats` table, run
`npx sequelize seed:generate --name cat-seeds`.

Then, edit the file created in the `seeders` folder to add entries into the
`Cats` table. Here's an example of some entries:

```js
module.exports = {
  up: (queryInterface, Sequelize) => {
    return queryInterface.bulkInsert('Cats', [
      {
        name: 'Fluffy',
        age: '2',
        createdAt: new Date(),
        updatedAt: new Date()
      },
      {
        name: 'Princess',
        age: '10',
        createdAt: new Date(),
        updatedAt: new Date()
      },
    ]);
  },
  down: (queryInterface, Sequelize) => {
    return queryInterface.bulkDelete('Cats', null, {});
  }
};
```

To run the seed file, run `npx sequelize db:seed:all`.

To undo the seeds, run `npx sequelize db:seed:undo:all`.

## Connecting to the Sequelize database

```js
try {
  await sequelize.authenticate();
} catch (e) {
 console.log("Database connection failure.");
 console.log(e);
 return;
}

console.log("Database connection success!");
console.log("Sequelize is ready to use!");

// execute Sequelize queries

await sequelize.close();
```

[Sequelize Migration docs]: https://sequelize.org/master/manual/migrations.html
